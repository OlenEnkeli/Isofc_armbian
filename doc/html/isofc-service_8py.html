<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Isofc for ArmBian: Файл isofc-service.py</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="isofc-ico.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Isofc for ArmBian
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Создано системой Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Поиск');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Поиск');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Классы</a> &#124;
<a href="#func-members">Функции</a> &#124;
<a href="#var-members">Переменные</a>  </div>
  <div class="headertitle">
<div class="title">Файл isofc-service.py</div>  </div>
</div><!--header-->
<div class="contents">

<p>Данный файл представляет собой сервис, который должен быть постоянно запущен на компьютере с доступом к SAMBA серверу  
<a href="#details">Подробнее...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Классы</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classisofc-service_1_1MainWindow.html">isofc-service.MainWindow</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classisofc-service_1_1MainThread.html">isofc-service.MainThread</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Тред окна, заменить на собственный директор  <a href="classisofc-service_1_1MainThread.html#details">Подробнее...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Функции</h2></td></tr>
<tr class="memitem:a5cea1ede56356bb641ac929c378c1dd8"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a5cea1ede56356bb641ac929c378c1dd8">isofc-service.Log</a> (message=&quot;\, include_info=True)</td></tr>
<tr class="memdesc:a5cea1ede56356bb641ac929c378c1dd8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция логирования сообщения с указанием даты  <a href="isofc-service_8py.html#a5cea1ede56356bb641ac929c378c1dd8">Подробнее...</a><br /></td></tr>
<tr class="separator:a5cea1ede56356bb641ac929c378c1dd8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5985ea75b9e7f9724d6cb7e742afc890"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a5985ea75b9e7f9724d6cb7e742afc890">isofc-service.DeviceHandlerExceptionWrapper</a> (action, device)</td></tr>
<tr class="memdesc:a5985ea75b9e7f9724d6cb7e742afc890"><td class="mdescLeft">&#160;</td><td class="mdescRight">Обработчик ошибок для Device Handler.  <a href="isofc-service_8py.html#a5985ea75b9e7f9724d6cb7e742afc890">Подробнее...</a><br /></td></tr>
<tr class="separator:a5985ea75b9e7f9724d6cb7e742afc890"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a72ca4fb69431072fffb6ac2059236878"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a72ca4fb69431072fffb6ac2059236878">isofc-service.DeviceHandler</a> (action, device)</td></tr>
<tr class="memdesc:a72ca4fb69431072fffb6ac2059236878"><td class="mdescLeft">&#160;</td><td class="mdescRight">Обработчик состояния устройства  <a href="isofc-service_8py.html#a72ca4fb69431072fffb6ac2059236878">Подробнее...</a><br /></td></tr>
<tr class="separator:a72ca4fb69431072fffb6ac2059236878"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a93c21c62e6b4cc45c8128d485d9709fb"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a93c21c62e6b4cc45c8128d485d9709fb">isofc-service.SmbNetFsInit</a> (SmbDirectory)</td></tr>
<tr class="memdesc:a93c21c62e6b4cc45c8128d485d9709fb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция инициализации Samba-подключения  <a href="isofc-service_8py.html#a93c21c62e6b4cc45c8128d485d9709fb">Подробнее...</a><br /></td></tr>
<tr class="separator:a93c21c62e6b4cc45c8128d485d9709fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab5986a73f27475fd45ad29ad87d7fc0a"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#ab5986a73f27475fd45ad29ad87d7fc0a">isofc-service.SmbNetFsClose</a> (SmbDirectory)</td></tr>
<tr class="memdesc:ab5986a73f27475fd45ad29ad87d7fc0a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция закрытия Samba-подключения  <a href="isofc-service_8py.html#ab5986a73f27475fd45ad29ad87d7fc0a">Подробнее...</a><br /></td></tr>
<tr class="separator:ab5986a73f27475fd45ad29ad87d7fc0a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af127619d58278714c207c58f6d85d52b"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#af127619d58278714c207c58f6d85d52b">isofc-service.SmbAuthp</a> (Credentials)</td></tr>
<tr class="memdesc:af127619d58278714c207c58f6d85d52b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция аутефикации на Samba-сервере  <a href="isofc-service_8py.html#af127619d58278714c207c58f6d85d52b">Подробнее...</a><br /></td></tr>
<tr class="separator:af127619d58278714c207c58f6d85d52b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3a76537b729e2a715e4c0c781f59f322"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a3a76537b729e2a715e4c0c781f59f322">isofc-service.base64p</a> (string)</td></tr>
<tr class="memdesc:a3a76537b729e2a715e4c0c781f59f322"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция проверки на кодировку base64.  <a href="isofc-service_8py.html#a3a76537b729e2a715e4c0c781f59f322">Подробнее...</a><br /></td></tr>
<tr class="separator:a3a76537b729e2a715e4c0c781f59f322"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0eba86fbc79aa01ca16b5fd058c85638"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a0eba86fbc79aa01ca16b5fd058c85638">isofc-service.Decrypt</a> (ciphertext)</td></tr>
<tr class="memdesc:a0eba86fbc79aa01ca16b5fd058c85638"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция расшифровки файла с данными авторизации  <a href="isofc-service_8py.html#a0eba86fbc79aa01ca16b5fd058c85638">Подробнее...</a><br /></td></tr>
<tr class="separator:a0eba86fbc79aa01ca16b5fd058c85638"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae80f4771b0644a980f33148b21453267"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#ae80f4771b0644a980f33148b21453267">isofc-service.CheckAuth</a> (device, usbdirectory)</td></tr>
<tr class="memdesc:ae80f4771b0644a980f33148b21453267"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция проверки аутефикации на Samba-сервере  <a href="isofc-service_8py.html#ae80f4771b0644a980f33148b21453267">Подробнее...</a><br /></td></tr>
<tr class="separator:ae80f4771b0644a980f33148b21453267"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a104b32abfb43e0783756cc675951fe97"><td class="memItemLeft" align="right" valign="top"><a id="a104b32abfb43e0783756cc675951fe97"></a>
def&#160;</td><td class="memItemRight" valign="bottom"><b>isofc-service.StatusSet</b> (device, message, color)</td></tr>
<tr class="separator:a104b32abfb43e0783756cc675951fe97"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ade5fb73a2623e6354a2453b612e1943b"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#ade5fb73a2623e6354a2453b612e1943b">isofc-service.Status</a> (device)</td></tr>
<tr class="memdesc:ade5fb73a2623e6354a2453b612e1943b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция получения статуса устройства  <a href="isofc-service_8py.html#ade5fb73a2623e6354a2453b612e1943b">Подробнее...</a><br /></td></tr>
<tr class="separator:ade5fb73a2623e6354a2453b612e1943b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad73dd86c759cc2bab83e283b1ec6f40e"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#ad73dd86c759cc2bab83e283b1ec6f40e">isofc-service.list_files</a> (startpath)</td></tr>
<tr class="memdesc:ad73dd86c759cc2bab83e283b1ec6f40e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция листинга файлов  <a href="isofc-service_8py.html#ad73dd86c759cc2bab83e283b1ec6f40e">Подробнее...</a><br /></td></tr>
<tr class="separator:ad73dd86c759cc2bab83e283b1ec6f40e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a316116b0d70bb8af538da4fab408d0cf"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a316116b0d70bb8af538da4fab408d0cf">isofc-service.directoryList</a> (path, regex='.*')</td></tr>
<tr class="memdesc:a316116b0d70bb8af538da4fab408d0cf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция листинга папок  <a href="isofc-service_8py.html#a316116b0d70bb8af538da4fab408d0cf">Подробнее...</a><br /></td></tr>
<tr class="separator:a316116b0d70bb8af538da4fab408d0cf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6d7f6ce07faf5f5b2588f8717407ca3b"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a6d7f6ce07faf5f5b2588f8717407ca3b">isofc-service.get_in_out</a> (root_path)</td></tr>
<tr class="memdesc:a6d7f6ce07faf5f5b2588f8717407ca3b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция получения листинга папок in и out.  <a href="isofc-service_8py.html#a6d7f6ce07faf5f5b2588f8717407ca3b">Подробнее...</a><br /></td></tr>
<tr class="separator:a6d7f6ce07faf5f5b2588f8717407ca3b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50b9ec7706ed7d16a1a8a40d544e86da"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a50b9ec7706ed7d16a1a8a40d544e86da">isofc-service.update_files</a> (usb_dir, files)</td></tr>
<tr class="memdesc:a50b9ec7706ed7d16a1a8a40d544e86da"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция обновлени файлов на флешке  <a href="isofc-service_8py.html#a50b9ec7706ed7d16a1a8a40d544e86da">Подробнее...</a><br /></td></tr>
<tr class="separator:a50b9ec7706ed7d16a1a8a40d544e86da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a439962da72c4d0e197a5e8247af9f379"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a439962da72c4d0e197a5e8247af9f379">isofc-service.gpg_decrypt</a> (path_to_file)</td></tr>
<tr class="memdesc:a439962da72c4d0e197a5e8247af9f379"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция верификации gpg.  <a href="isofc-service_8py.html#a439962da72c4d0e197a5e8247af9f379">Подробнее...</a><br /></td></tr>
<tr class="separator:a439962da72c4d0e197a5e8247af9f379"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2121e73bea9129e558eba2f542c9ae75"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a2121e73bea9129e558eba2f542c9ae75">isofc-service.do_admin_work</a> (usb_in)</td></tr>
<tr class="memdesc:a2121e73bea9129e558eba2f542c9ae75"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция обновления системы isofc.  <a href="isofc-service_8py.html#a2121e73bea9129e558eba2f542c9ae75">Подробнее...</a><br /></td></tr>
<tr class="separator:a2121e73bea9129e558eba2f542c9ae75"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac3a9b4525481c6bc4b39f8c382294cf3"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#ac3a9b4525481c6bc4b39f8c382294cf3">isofc-service.Transfer</a> (device, UsbDirectory, Credentials)</td></tr>
<tr class="memdesc:ac3a9b4525481c6bc4b39f8c382294cf3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция обмена данными между флешкой и сетевым диском  <a href="isofc-service_8py.html#ac3a9b4525481c6bc4b39f8c382294cf3">Подробнее...</a><br /></td></tr>
<tr class="separator:ac3a9b4525481c6bc4b39f8c382294cf3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9952a920fb26ea812b546c82bf64db4"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#ad9952a920fb26ea812b546c82bf64db4">isofc-service.Port</a> (device)</td></tr>
<tr class="memdesc:ad9952a920fb26ea812b546c82bf64db4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция проброски портов  <a href="isofc-service_8py.html#ad9952a920fb26ea812b546c82bf64db4">Подробнее...</a><br /></td></tr>
<tr class="separator:ad9952a920fb26ea812b546c82bf64db4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad24525bcc431f0f8c030e24bed019a6f"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#ad24525bcc431f0f8c030e24bed019a6f">isofc-service.UsbMount</a> (device)</td></tr>
<tr class="memdesc:ad24525bcc431f0f8c030e24bed019a6f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция монтирования usb.  <a href="isofc-service_8py.html#ad24525bcc431f0f8c030e24bed019a6f">Подробнее...</a><br /></td></tr>
<tr class="separator:ad24525bcc431f0f8c030e24bed019a6f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8078bdb80f1dc3e035795dbceec779aa"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a8078bdb80f1dc3e035795dbceec779aa">isofc-service.UsbUmount</a> (device)</td></tr>
<tr class="memdesc:a8078bdb80f1dc3e035795dbceec779aa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция размонтирования usb.  <a href="isofc-service_8py.html#a8078bdb80f1dc3e035795dbceec779aa">Подробнее...</a><br /></td></tr>
<tr class="separator:a8078bdb80f1dc3e035795dbceec779aa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7d6f596c01260b208bc72a0c7722337f"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a7d6f596c01260b208bc72a0c7722337f">isofc-service.getstatusoutput</a> (cmd, shell=True, timeout=0, logging=False)</td></tr>
<tr class="memdesc:a7d6f596c01260b208bc72a0c7722337f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Функция получения ответа от системной команды  <a href="isofc-service_8py.html#a7d6f596c01260b208bc72a0c7722337f">Подробнее...</a><br /></td></tr>
<tr class="separator:a7d6f596c01260b208bc72a0c7722337f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Переменные</h2></td></tr>
<tr class="memitem:a86c2854b086f3034ce6820a9db41f34b"><td class="memItemLeft" align="right" valign="top">dictionary&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="isofc-service_8py.html#a86c2854b086f3034ce6820a9db41f34b">isofc-service.StatusMsg</a></td></tr>
<tr class="memdesc:a86c2854b086f3034ce6820a9db41f34b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Сообщения для вывода на дисплей  <a href="isofc-service_8py.html#a86c2854b086f3034ce6820a9db41f34b">Подробнее...</a><br /></td></tr>
<tr class="separator:a86c2854b086f3034ce6820a9db41f34b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a32430ce5e336e5cb8ec2df27f66b86dd"><td class="memItemLeft" align="right" valign="top">dictionary&#160;</td><td class="memItemRight" valign="bottom"><b>isofc-service.StatusClrs</b></td></tr>
<tr class="separator:a32430ce5e336e5cb8ec2df27f66b86dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1a05ad08514211f9ef48bee10308ea73"><td class="memItemLeft" align="right" valign="top"><a id="a1a05ad08514211f9ef48bee10308ea73"></a>
string&#160;</td><td class="memItemRight" valign="bottom"><b>isofc-service.Port</b> = &quot;Port&quot; + str(PortNum) + &quot;Status&quot;</td></tr>
<tr class="separator:a1a05ad08514211f9ef48bee10308ea73"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Подробное описание</h2>
<div class="textblock"><p>Данный файл представляет собой сервис, который должен быть постоянно запущен на компьютере с доступом к SAMBA серверу </p>
<p>Что-то надо сюда дописать </p>
</div><h2 class="groupheader">Функции</h2>
<a id="file_a3a76537b729e2a715e4c0c781f59f322"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a3a76537b729e2a715e4c0c781f59f322">&#9670;&nbsp;</a></span>base64p()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.base64p </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>string</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция проверки на кодировку base64. </p>
<p>Проверка осуществляется с помощью регулярных выражений </p><dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">string</td><td>- входная строка </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="keyword">def </span>base64p(string):</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordflow">if</span> re.match(<span class="stringliteral">&#39;^(?:[A-Za-z0-9+/]{4})*&#39;</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                        + <span class="stringliteral">&#39;(?:[A-Za-z0-9+/]{2}==&#39;</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                        + <span class="stringliteral">&#39;|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})$&#39;</span>, string):</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">True</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_ae80f4771b0644a980f33148b21453267"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_ae80f4771b0644a980f33148b21453267">&#9670;&nbsp;</a></span>CheckAuth()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.CheckAuth </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>usbdirectory</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция проверки аутефикации на Samba-сервере </p>
<p>Идет проверка на существование файла ./isofc_credentials</p>
<p>Файл расшифровывается, сверяется serial id устройства в usb порте и serial id из файла аутефикации</p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">ciphertext</td><td>- входная строка (зашифрованный текст) </td></tr>
    <tr><td class="paramname">private_key_path</td><td>- путь к файлу секретного ключа </td></tr>
    <tr><td class="paramname">opentext</td><td>- расшифрованный текст </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="keyword">def </span>CheckAuth(device, usbdirectory):</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        with open(usbdirectory + <span class="stringliteral">&quot;/.isofc_credentials&quot;</span>, <span class="stringliteral">&quot;r&quot;) as file:</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="stringliteral">            data = file.read().replace(&#39;\n&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="keywordflow">except</span> IOError <span class="keyword">as</span> exc:</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        <span class="keywordflow">if</span> exc.errno == 2:</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            <span class="keywordflow">return</span> [<span class="keyword">False</span>, StatusMsg[<span class="stringliteral">&#39;AuthFileNotFoundError&#39;</span>]] <span class="comment"># Нет файла аутенфикации</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            <span class="keywordflow">raise</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    Credentials = Decrypt(data) <span class="comment"># функция расшифровки файла аутенфикации</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keywordflow">if</span> Credentials == <span class="stringliteral">&#39;Error&#39;</span>:</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="keywordflow">return</span> [<span class="keyword">False</span>, StatusMsg[<span class="stringliteral">&#39;WrongAuthFileError&#39;</span>]]</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        Credentials = json.loads(Credentials)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        serial = device[<span class="stringliteral">&#39;ID_SERIAL_SHORT&#39;</span>]</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keywordflow">except</span>:</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">return</span> [<span class="keyword">False</span>, StatusMsg[<span class="stringliteral">&#39;WrongAuthFileError&#39;</span>]]</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keywordflow">if</span> serial.lower() != Credentials[<span class="stringliteral">&#39;Serial&#39;</span>].lower():</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        Log(<span class="stringliteral">&quot;Serial ID in credentials (&quot;</span> + serial.lower()</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            + <span class="stringliteral">&quot;) is not equal serial ID in usb device (&quot;</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            + Credentials[<span class="stringliteral">&#39;Serial&#39;</span>].lower() + <span class="stringliteral">&quot;)&quot;</span>)</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <span class="keywordflow">return</span> [<span class="keyword">False</span>, StatusMsg[<span class="stringliteral">&#39;WrongAuthFileError&#39;</span>]]</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="keywordflow">return</span> [<span class="keyword">True</span>, Credentials[<span class="stringliteral">&#39;Login&#39;</span>], Credentials[<span class="stringliteral">&#39;Password&#39;</span>],</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            serial]</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a0eba86fbc79aa01ca16b5fd058c85638"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a0eba86fbc79aa01ca16b5fd058c85638">&#9670;&nbsp;</a></span>Decrypt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.Decrypt </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>ciphertext</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция расшифровки файла с данными авторизации </p>
<p>Идет проверка на существование файла секретного ключа.</p>
<p>Файл расшифровывается последовательно base64 -&gt; rsa с помошью секретного ключа </p><dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">ciphertext</td><td>- входная строка (зашифрованный текст) </td></tr>
    <tr><td class="paramname">private_key_path</td><td>- путь к файлу секретного ключа </td></tr>
    <tr><td class="paramname">opentext</td><td>- расшифрованный текст </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keyword">def </span>Decrypt(ciphertext):</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keyword">global</span> config</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.isfile(config.private_key_path):</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        Log(<span class="stringliteral">&quot;Private key not found&quot;</span>)</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;Error&#39;</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> base64p(ciphertext):</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        Log(<span class="stringliteral">&quot;.isofc_credentials is not base64, Ciphertext = &#39;&quot;</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            + str(ciphertext) + <span class="stringliteral">&quot;&#39;&quot;</span>)</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;Error&#39;</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    retcode, opentext = getstatusoutput(</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="stringliteral">&quot;echo &quot;</span> + ciphertext + <span class="stringliteral">&quot;|base64 -d|openssl rsautl -inkey &quot;</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        + config.private_key_path + <span class="stringliteral">&quot; -decrypt&quot;</span>)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    Log(<span class="stringliteral">&quot;Retcode(decrypt): &quot;</span> + str(retcode))</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="keywordflow">if</span> retcode == 0:</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keywordflow">return</span> opentext</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;Error&#39;</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a72ca4fb69431072fffb6ac2059236878"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a72ca4fb69431072fffb6ac2059236878">&#9670;&nbsp;</a></span>DeviceHandler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.DeviceHandler </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>action</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Обработчик состояния устройства </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">action</td><td>действие, совршаемое над устройством </td></tr>
    <tr><td class="paramname">device</td><td>устройство </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="keyword">def </span>DeviceHandler(action, device):</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment"># \todo удалить, связано с GTK</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    getstatusoutput([<span class="stringliteral">&quot;xset&quot;</span>, <span class="stringliteral">&quot;-dpms&quot;</span>], <span class="keyword">False</span>)</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    getstatusoutput([<span class="stringliteral">&quot;xset&quot;</span>, <span class="stringliteral">&quot;+dpms&quot;</span>], <span class="keyword">False</span>)</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        Log(<span class="stringliteral">&quot;Port: &quot;</span> + str(Port(device)) + <span class="stringliteral">&quot;, &quot;</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            + <span class="stringliteral">&quot;Action: &quot;</span> + str(action) + <span class="stringliteral">&quot;, &quot;</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            + <span class="stringliteral">&quot;DEVNAME: &quot;</span> + str(device[<span class="stringliteral">&#39;DEVNAME&#39;</span>]) + <span class="stringliteral">&quot;, &quot;</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            + <span class="stringliteral">&quot;ID_SERIAL: &quot;</span> + str(device[<span class="stringliteral">&#39;ID_SERIAL&#39;</span>]) + <span class="stringliteral">&quot; &quot;</span>)</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keywordflow">except</span>:</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        Log(<span class="stringliteral">&quot;Fail on Port: &quot;</span> + str(Port(device)) + <span class="stringliteral">&quot;, &quot;</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            + <span class="stringliteral">&quot;Action: &quot;</span> + str(action))</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keyword">global</span> Clients, Ports, ExitFlag, RestartFlag</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    PortLock = <span class="stringliteral">&quot;Port&quot;</span> + str(Port(device)) + <span class="stringliteral">&quot;Lock&quot;</span> <span class="comment"># закрытие портов</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    exec(<span class="stringliteral">&#39;global &#39;</span> + PortLock)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordflow">if</span> str(action) == <span class="stringliteral">&quot;add&quot;</span>:</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="keywordflow">if</span> len(str(device.device_node)) == 8:</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            <span class="keywordflow">if</span> sum(1 <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> device.children) != 0:</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                Log(str(device.device_node)</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                    + <span class="stringliteral">&quot; is not mount (partition table)&quot;</span>)</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                exec(PortLock + <span class="stringliteral">&#39;.acquire()&#39;</span>, locals(), globals())</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="keywordflow">if</span> list(filter(<span class="keyword">lambda</span> pt: pt == Port(device), Ports)):</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            Log(str(device.device_node) + <span class="stringliteral">&quot; will not be served&quot;</span>)</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            exec(PortLock + <span class="stringliteral">&#39;.release()&#39;</span>, locals(), globals())</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        StatusSet(device, StatusMsg[<span class="stringliteral">&#39;Connected&#39;</span>],</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                  StatusClrs[<span class="stringliteral">&#39;Normal&#39;</span>])</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        retval, usbdirectory = UsbMount(device)</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="keywordflow">if</span> retval != 0:</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            Log(<span class="stringliteral">&quot;Cannot mount &quot;</span> + str(device.device_node))</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="keywordflow">if</span> Status(device) != StatusMsg[<span class="stringliteral">&#39;Free&#39;</span>]:</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                StatusSet(device, StatusMsg[<span class="stringliteral">&#39;MountError&#39;</span>],</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                          StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                <span class="keywordflow">try</span>:</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                    exec(PortLock + <span class="stringliteral">&#39;.release()&#39;</span>, locals(), globals())</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                <span class="keywordflow">except</span>:</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                    <span class="keywordflow">pass</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        Log(str(device.device_node) + <span class="stringliteral">&quot; mounted&quot;</span>)</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        Credentials = CheckAuth(device, usbdirectory)</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="keywordflow">if</span> Credentials[0] <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keyword">True</span>:</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            StatusSet(device, Credentials[1],</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                      StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;            <span class="keywordflow">if</span> Credentials[1] == StatusMsg[<span class="stringliteral">&#39;WrongAuthFileError&#39;</span>]:</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                Ports.append(Port(device))</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            Log(str(device.device_node) + <span class="stringliteral">&quot;, &quot;</span> + <span class="stringliteral">&quot;Login: &quot;</span> + Credentials[1] + <span class="stringliteral">&quot;, &quot;</span> + <span class="stringliteral">&quot;Serial: &quot;</span> + Credentials[3])</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            Ports.append(Port(device))</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            exec(PortLock + <span class="stringliteral">&#39;.release()&#39;</span>, locals(), globals())</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;            ClientsLock.acquire()</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <span class="keywordflow">if</span> list(filter(<span class="keyword">lambda</span> cl: cl[1] == Credentials[1],</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                           Clients)):</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                StatusSet(device, StatusMsg[<span class="stringliteral">&#39;MoreOneLogin&#39;</span>], <span class="comment"># если больше одного логина</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                          StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                ClientsLock.release()</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                Clients.append([device.device_node, Credentials[1]])</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                ClientsLock.release()</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                StatusSet(device, StatusMsg[<span class="stringliteral">&#39;Connecting&#39;</span>],</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                          StatusClrs[<span class="stringliteral">&#39;Normal&#39;</span>])</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                smb_auth_result = SmbAuthp(Credentials)</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                <span class="keywordflow">if</span> smb_auth_result == 0:</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> Transfer(device,</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                                    usbdirectory,</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                                    Credentials):</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                        StatusSet(device,</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                                  StatusMsg[<span class="stringliteral">&#39;TransferError&#39;</span>],</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                                  StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                        Log(str(device.device_node) + <span class="stringliteral">&quot; All good&quot;</span>)</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                <span class="keywordflow">elif</span> smb_auth_result == 256:  <span class="comment"># timeout</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                    StatusSet(device,</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                              StatusMsg[<span class="stringliteral">&#39;ConnectingError&#39;</span>],</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                              StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                    StatusSet(device,</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                              StatusMsg[<span class="stringliteral">&#39;AuthSmbError&#39;</span>], <span class="comment"># ошибка аутенфикации samba</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                              StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                    Log(str(device.device_node) + <span class="stringliteral">&quot;, wrong credentials&quot;</span>)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordflow">if</span> UsbUmount(device) != 0:</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            Log(str(device.device_node) + <span class="stringliteral">&quot;, failed umount&quot;</span>)</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            StatusSet(device, StatusMsg[<span class="stringliteral">&#39;UmountError&#39;</span>],</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                      StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <span class="comment"># \todo : удалить, связано с GTK</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                exec(PortLock + <span class="stringliteral">&#39;.release()&#39;</span>, locals(), globals())</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;            <span class="keywordflow">except</span>:</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                <span class="keywordflow">pass</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="comment">#</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">if</span> str(action) == <span class="stringliteral">&quot;remove&quot;</span>:</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        Clients = list(filter(</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <span class="keyword">lambda</span> cl: cl[0] != device.device_node, Clients))</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        Ports = list(filter(<span class="keyword">lambda</span> pt: pt != Port(device), Ports))</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment"># \todo : удалить, связано с GTK</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            exec(PortLock + <span class="stringliteral">&#39;.release()&#39;</span>, locals(), globals())</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">except</span>:</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            <span class="keywordflow">pass</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="comment">#</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        StatusSet(device, StatusMsg[<span class="stringliteral">&#39;Free&#39;</span>],</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                  StatusClrs[<span class="stringliteral">&#39;Normal&#39;</span>])</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="keywordflow">if</span> len(Ports) == 0 <span class="keywordflow">and</span> ExitFlag:</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            RestartFlag = <span class="keyword">True</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            ExitFlag = <span class="keyword">False</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment"># \todo  удалить, связано с GTK</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            <span class="keyword">global</span> Gtk</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            Log(<span class="stringliteral">&quot;Gtk main_quit&quot;</span>)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            Gtk.main_quit()</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">except</span>:</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;            ExitFlag = <span class="keyword">True</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a5985ea75b9e7f9724d6cb7e742afc890"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a5985ea75b9e7f9724d6cb7e742afc890">&#9670;&nbsp;</a></span>DeviceHandlerExceptionWrapper()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.DeviceHandlerExceptionWrapper </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>action</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Обработчик ошибок для Device Handler. </p>
<p>В случае возникновения исключение сообщение логируется </p><dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">action</td><td>действие, совршаемое над устройством </td></tr>
    <tr><td class="paramname">device</td><td>устройство </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="keyword">def </span>DeviceHandlerExceptionWrapper(action, device):</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        DeviceHandler(action, device)</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        Log(str(e))</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a316116b0d70bb8af538da4fab408d0cf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a316116b0d70bb8af538da4fab408d0cf">&#9670;&nbsp;</a></span>directoryList()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.directoryList </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>regex</em> = <code>'.*'</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция листинга папок </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">path</td><td>- путь до папки </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keyword">def </span>directoryList(path, regex=&#39;.*&#39;):</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="keywordflow">return</span> [o <span class="keywordflow">for</span> o <span class="keywordflow">in</span> os.listdir(path)</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            <span class="keywordflow">if</span> os.path.isdir(os.path.join(path, o))</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="keywordflow">and</span> re.match(regex, o)]</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a2121e73bea9129e558eba2f542c9ae75"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a2121e73bea9129e558eba2f542c9ae75">&#9670;&nbsp;</a></span>do_admin_work()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.do_admin_work </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>usb_in</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция обновления системы isofc. </p>
<p>Если вставленная флешка прошла аутекацию как админ, файлы системы обновляются</p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">usb_in</td><td>- путь до папки in на флешке </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="keyword">def </span>do_admin_work(usb_in):</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="keyword">global</span> config</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    update_files(usb_in, [<span class="stringliteral">&quot;isofc-service.py&quot;</span>,</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                          <span class="stringliteral">&quot;isofc-service.conf&quot;</span>])</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    getstatusoutput([<span class="stringliteral">&quot;/bin/cp&quot;</span>,</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                     config.log_filepath,</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                     usb_in + <span class="stringliteral">&quot;/&quot;</span>],</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                    shell=<span class="keyword">False</span>)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a6d7f6ce07faf5f5b2588f8717407ca3b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a6d7f6ce07faf5f5b2588f8717407ca3b">&#9670;&nbsp;</a></span>get_in_out()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.get_in_out </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>root_path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция получения листинга папок in и out. </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">root_path</td><td>- путь до сетевого диска </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keyword">def </span>get_in_out(root_path):</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    ins = directoryList(root_path, <span class="stringliteral">&#39;^(?i)in$&#39;</span>)</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    outs = directoryList(root_path, <span class="stringliteral">&#39;^(?i)out$&#39;</span>)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    ins.sort(reverse=<span class="keyword">True</span>)</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    outs.sort(reverse=<span class="keyword">True</span>)</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        _in = ins[0]</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordflow">except</span> IndexError:</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        _in = <span class="stringliteral">&quot;in&quot;</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        _out = outs[0]</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="keywordflow">except</span> IndexError:</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        _out = <span class="stringliteral">&quot;out&quot;</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordflow">return</span> (root_path + <span class="stringliteral">&quot;/&quot;</span> + _in + <span class="stringliteral">&quot;/&quot;</span>,</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            root_path + <span class="stringliteral">&quot;/&quot;</span> + _out + <span class="stringliteral">&quot;/&quot;</span>)</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a7d6f596c01260b208bc72a0c7722337f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a7d6f596c01260b208bc72a0c7722337f">&#9670;&nbsp;</a></span>getstatusoutput()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.getstatusoutput </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>shell</em> = <code>True</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>timeout</em> = <code>0</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>logging</em> = <code>False</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция получения ответа от системной команды </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">cmd</td><td>- исполняема команда </td></tr>
    <tr><td class="paramname">shell</td><td>- нужно ли открытие shell </td></tr>
    <tr><td class="paramname">logging</td><td>- нужно ли логирование <pre class="fragment">Return (status, output) of executing cmd in a shell.</pre> <pre class="fragment">This new implementation should work on all platforms.</pre> </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keyword">def </span>getstatusoutput(cmd, shell=True, timeout=0, logging=False):</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Return (status, output) of executing cmd in a shell.&quot;&quot;&quot;</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;This new implementation should work on all platforms.&quot;&quot;&quot;</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    pipe = subprocess.Popen(cmd, shell=shell,</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                            universal_newlines=<span class="keyword">True</span>,</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                            stdout=subprocess.PIPE,</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                            stderr=subprocess.STDOUT)</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    deadline = time.time() + timeout</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordflow">if</span> timeout:</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="keywordflow">while</span> pipe.poll() <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> time.time() &lt; deadline:</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            time.sleep(.250)</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keywordflow">if</span> pipe.poll() <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            pipe.terminate()</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            <span class="keywordflow">return</span> 256, <span class="stringliteral">&quot;&quot;</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    sts = pipe.wait()</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    output = str.join(<span class="stringliteral">&quot;&quot;</span>, pipe.stdout.readlines())</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <span class="keywordflow">if</span> sts <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        sts = 0</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <span class="keywordflow">if</span> logging <span class="keywordflow">and</span> (sts != 0):</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        Log(output)</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="keywordflow">return</span> sts, output</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a439962da72c4d0e197a5e8247af9f379"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a439962da72c4d0e197a5e8247af9f379">&#9670;&nbsp;</a></span>gpg_decrypt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.gpg_decrypt </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>path_to_file</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция верификации gpg. </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">path_to_file</td><td>- путь до файла </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="keyword">def </span>gpg_decrypt(path_to_file):</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    orig_file = path_to_file.replace(<span class="stringliteral">&#39;.gpg&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    getstatusoutput(<span class="stringliteral">&quot;rm &quot;</span> + orig_file)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    status, output = getstatusoutput(<span class="stringliteral">&quot;gpg &quot;</span> + path_to_file)</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    Log(<span class="stringliteral">&quot;Status: &quot;</span> + str(status) + <span class="stringliteral">&quot;; &quot;</span> + output.replace(<span class="stringliteral">&#39;\n&#39;</span>, <span class="stringliteral">&#39;; &#39;</span>))</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="keywordflow">if</span> status == 0 <span class="keywordflow">and</span> re.findall(<span class="stringliteral">&#39;ID &#39;</span> + config.admin_rsa_id,</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                                  output.splitlines()[0]):</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        Log(<span class="stringliteral">&quot;Gpg verify: true sign&quot;</span>)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keywordflow">return</span> orig_file</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        Log(<span class="stringliteral">&quot;Gpg verify: bad sign&quot;</span>)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_ad73dd86c759cc2bab83e283b1ec6f40e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_ad73dd86c759cc2bab83e283b1ec6f40e">&#9670;&nbsp;</a></span>list_files()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.list_files </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>startpath</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция листинга файлов </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">startpath</td><td>- начальная папка </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keyword">def </span>list_files(startpath):</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="keywordflow">for</span> root, dirs, files <span class="keywordflow">in</span> os.walk(startpath):</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        level = root.replace(startpath, <span class="stringliteral">&#39;&#39;</span>).count(os.sep)</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        indent = <span class="stringliteral">&#39; &#39;</span> * 4 * (level)</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        Log(<span class="stringliteral">&#39;{}{}/&#39;</span>.format(indent, os.path.basename(root)))</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        subindent = <span class="stringliteral">&#39; &#39;</span> * 4 * (level + 1)</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <span class="keywordflow">for</span> f <span class="keywordflow">in</span> files:</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            Log(<span class="stringliteral">&#39;{}{}&#39;</span>.format(subindent, f))</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a5cea1ede56356bb641ac929c378c1dd8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a5cea1ede56356bb641ac929c378c1dd8">&#9670;&nbsp;</a></span>Log()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.Log </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>message</em> = <code>&quot;\n&quot;</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>include_info</em> = <code>True</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция логирования сообщения с указанием даты </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">message</td><td>Логируемое сообщение </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">def </span>Log(message=&quot;\n&quot;,include_info=True):</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keyword">global</span> config</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">if</span> include_info:</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        log_message = str(str(time.strftime(<span class="stringliteral">&quot;[%d %b %Y %H:%M:%S] (&quot;</span>))</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                        + current_thread().name + <span class="stringliteral">&quot;) &quot;</span> + str(message))</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        log_message = str(message)</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    print(log_message)</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    with open(config.log_filepath, <span class="stringliteral">&quot;a+&quot;</span>) <span class="keyword">as</span> f:</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        f.write(log_message + <span class="stringliteral">&quot;\n&quot;</span>)</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_ad9952a920fb26ea812b546c82bf64db4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_ad9952a920fb26ea812b546c82bf64db4">&#9670;&nbsp;</a></span>Port()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.Port </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция проброски портов </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">device</td><td>- устройство </td></tr>
  </table>
  </dd>
</dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Необходимо сделать:</a></b></dt><dd>заменить на 2 порта </dd></dl>
<div class="fragment"><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="keyword">def </span>Port(device):</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="keywordflow">return</span> {</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        <span class="stringliteral">&#39;4&#39;</span>: 7,</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <span class="stringliteral">&#39;3&#39;</span>: 6,</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <span class="stringliteral">&#39;7&#39;</span>: 5,</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="stringliteral">&#39;2&#39;</span>: 4,</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <span class="stringliteral">&#39;1&#39;</span>: 3,</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="stringliteral">&#39;6&#39;</span>: 2,</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="stringliteral">&#39;5&#39;</span>: 1,</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    }[str(device.device_path)[46]]</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_af127619d58278714c207c58f6d85d52b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_af127619d58278714c207c58f6d85d52b">&#9670;&nbsp;</a></span>SmbAuthp()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.SmbAuthp </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>Credentials</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция аутефикации на Samba-сервере </p>
<p>Выполняет подключение к Samba-серверу с помощью команды ls</p>
<p>Обрашение к папке на сервере происходит в виде:</p>
<div class="fragment"><div class="line">/bin/ls папка_самбы/логин:пароль@ip_адрес/логин</div></div><!-- fragment --> <dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">Credentials</td><td>- данные для авторизации </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keyword">def </span>SmbAuthp(Credentials):</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keyword">global</span> config</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    Login, Password = Credentials[1], Credentials[2]</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> re.match(<span class="stringliteral">&#39;^[a-zA-Z0-9]*$&#39;</span>, Login):</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        Log(<span class="stringliteral">&quot;login contain unacceptable symbols: &quot;</span> + str(Login))</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordflow">return</span> getstatusoutput([<span class="stringliteral">&quot;/bin/ls&quot;</span>, config.smbnetfs_directory</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                            + <span class="stringliteral">&quot;/&quot;</span> + Login</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                            + <span class="stringliteral">&quot;:&quot;</span> + Password</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                            + <span class="stringliteral">&quot;@&quot;</span> + config.server_ip + <span class="stringliteral">&quot;/&quot;</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                            + Login], <span class="keyword">False</span>, timeout=20)[0]</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_ab5986a73f27475fd45ad29ad87d7fc0a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_ab5986a73f27475fd45ad29ad87d7fc0a">&#9670;&nbsp;</a></span>SmbNetFsClose()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.SmbNetFsClose </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>SmbDirectory</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция закрытия Samba-подключения </p>
<p>С помощью команды fusermount выполняется размонтирование папки Samba-пользователя </p>
<div class="fragment"><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="keyword">def </span>SmbNetFsClose(SmbDirectory):</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">return</span> getstatusoutput([<span class="stringliteral">&quot;/bin/fusermount&quot;</span>, <span class="stringliteral">&quot;-u&quot;</span>,</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                            SmbDirectory], <span class="keyword">False</span>)[0] == 0</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a93c21c62e6b4cc45c8128d485d9709fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a93c21c62e6b4cc45c8128d485d9709fb">&#9670;&nbsp;</a></span>SmbNetFsInit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.SmbNetFsInit </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>SmbDirectory</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция инициализации Samba-подключения </p>
<p>С помощью команды smbnetfs выполняется монтирование в определнную папки</p>
<p>При возникновение ошибки соединения закрывается  SmbDirectory - папка для монтирования Samba-клиента </p>
<div class="fragment"><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="keyword">def </span>SmbNetFsInit(SmbDirectory):</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        os.makedirs(SmbDirectory, exist_ok=<span class="keyword">True</span>)</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">except</span> OSError <span class="keyword">as</span> e:</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordflow">if</span> e.errno == 17:</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            SmbNetFsClose(SmbDirectory)</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            <span class="keywordflow">raise</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    retcode, output = getstatusoutput([<span class="stringliteral">&quot;/usr/bin/smbnetfs&quot;</span>,</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                                       SmbDirectory], <span class="keyword">False</span>)</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    Log(<span class="stringliteral">&quot;Smbnetfs init: &quot;</span> + <span class="stringliteral">&quot;retcode: &quot;</span> + str(retcode) + <span class="stringliteral">&quot;, &quot;</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        + <span class="stringliteral">&quot;output: &quot;</span> + output)</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">return</span> output == <span class="stringliteral">&quot;&quot;</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_ade5fb73a2623e6354a2453b612e1943b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_ade5fb73a2623e6354a2453b612e1943b">&#9670;&nbsp;</a></span>Status()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.Status </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция получения статуса устройства </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">device</td><td>- устройство </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keyword">def </span>Status(device):</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keywordflow">for</span> PortNum <span class="keywordflow">in</span> range(1, 8): <span class="comment"># \todo поменять на 2</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        _Port = <span class="stringliteral">&quot;Port&quot;</span> + str(PortNum) + <span class="stringliteral">&quot;Status&quot;</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        exec(<span class="stringliteral">&#39;global &#39;</span> + _Port)</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">return</span> re.sub(<span class="stringliteral">&#39;&lt;[^&gt;]*&gt;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                 eval(<span class="stringliteral">&#39;Port&#39;</span> + str(Port(device)) + <span class="stringliteral">&#39;Status&#39;</span>))</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_ac3a9b4525481c6bc4b39f8c382294cf3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_ac3a9b4525481c6bc4b39f8c382294cf3">&#9670;&nbsp;</a></span>Transfer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.Transfer </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>UsbDirectory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>Credentials</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция обмена данными между флешкой и сетевым диском </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">device</td><td>- устройство </td></tr>
    <tr><td class="paramname">UsbDirectory</td><td>- папка до флешки, Credentials - данные авторизации </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="keyword">def </span>Transfer(device, UsbDirectory, Credentials):</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    Log(<span class="stringliteral">&quot;Start transfer&quot;</span>)</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keyword">global</span> config</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    Login, Password = Credentials[1], Credentials[2]</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    UserDirectory = str(config.smbnetfs_directory + <span class="stringliteral">&quot;/&quot;</span> + Login</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                        + <span class="stringliteral">&quot;:&quot;</span> + Password</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                        + <span class="stringliteral">&quot;@&quot;</span> + config.server_ip + <span class="stringliteral">&quot;/&quot;</span> + Login) <span class="comment"># аутентификация на samba-сервере</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    smbIn, smbOut = get_in_out(UserDirectory) <span class="comment"># листинг папок пользователя на сетевом диске</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    usbIn, usbOut = get_in_out(UsbDirectory) <span class="comment"># листинг папок на флешке</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordflow">if</span> Status(device) != StatusMsg[<span class="stringliteral">&#39;Free&#39;</span>]:</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        StatusSet(device, StatusMsg[<span class="stringliteral">&#39;Copying&#39;</span>],</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                  StatusClrs[<span class="stringliteral">&#39;Copying&#39;</span>])</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordflow">for</span> _dir <span class="keywordflow">in</span> [smbIn, smbOut, usbIn, usbOut]:</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;            os.makedirs(_dir, exist_ok=<span class="keyword">True</span>) <span class="comment"># создание папок</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            <span class="keywordflow">if</span> e.errno != 17:</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                Log(str(e))</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            <span class="keywordflow">pass</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keywordflow">if</span> Login == config.admin:</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            Log(<span class="stringliteral">&quot;Admin login: &quot;</span> + Login)</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            do_admin_work(usbIn) <span class="comment"># выполнение &quot;админской работы&quot;, в случае, если флешка пренадлежит администратору</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        Log(<span class="stringliteral">&quot;Error while admin work: &quot;</span> + str(e))</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    retcodeU = 0 <span class="comment"># флаг успешности копирования сетевой диск -&gt; флешка</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    retcodeD = 0 <span class="comment"># флаг успешности копирования флешка -&gt; сетевой диск</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    Log(<span class="stringliteral">&quot;List of smb/Out:&quot;</span>)</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    list_files(smbOut)</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    Log(<span class="stringliteral">&quot;List of usb/Out:&quot;</span>)</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    list_files(usbOut)</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="keywordflow">for</span> directory <span class="keywordflow">in</span> [smbOut, smbIn, usbOut, usbIn]:</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <span class="keywordflow">if</span> os.path.islink(directory):</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                Log(str(directory) + <span class="stringliteral">&quot; is symlink&quot;</span>)</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        <span class="keywordflow">for</span> _dir <span class="keywordflow">in</span> os.listdir(smbOut):</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            <span class="keywordflow">if</span> getstatusoutput([<span class="stringliteral">&quot;/bin/cp&quot;</span>, <span class="stringliteral">&quot;-R&quot;</span>,</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                                smbOut + _dir, usbIn + _dir],</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                               shell=<span class="keyword">False</span>)[0] == 0: <span class="comment"># копирование с папки out на диске в папку in на флешке</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                retcodeU = getstatusoutput([<span class="stringliteral">&quot;/bin/rm&quot;</span>, <span class="comment"># удаление файлов из папки out на сетевом диске</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                                            smbOut + _dir, <span class="stringliteral">&quot;-rf&quot;</span>],</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                                           shell=<span class="keyword">False</span>)[0]</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                retcodeU = 1</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        <span class="keywordflow">for</span> _dir <span class="keywordflow">in</span> os.listdir(usbOut):</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;            <span class="keywordflow">if</span> getstatusoutput([<span class="stringliteral">&quot;/bin/cp&quot;</span>, <span class="stringliteral">&quot;-R&quot;</span>,</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                                usbOut + _dir, smbIn + _dir],</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                               shell=<span class="keyword">False</span>)[0] == 0:  <span class="comment"># копирование с папки out на сетевом диске в папку in на флешке</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                retcodeD = getstatusoutput([<span class="stringliteral">&quot;/bin/rm&quot;</span>,</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                                            usbOut + _dir, <span class="stringliteral">&quot;-rf&quot;</span>],</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                                           shell=<span class="keyword">False</span>)[0]</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                retcodeD = 1</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordflow">except</span>:</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        Log(str(sys.exc_info()[1]))</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keywordflow">pass</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="keywordflow">return</span> retcodeU + retcodeD == 0</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a50b9ec7706ed7d16a1a8a40d544e86da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a50b9ec7706ed7d16a1a8a40d544e86da">&#9670;&nbsp;</a></span>update_files()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.update_files </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>usb_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>files</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция обновлени файлов на флешке </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">usb_dir</td><td>- папка до флешки </td></tr>
    <tr><td class="paramname">files</td><td>- массив названий файлов, которые нужно скопировать </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="keyword">def </span>update_files(usb_dir, files):</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="keyword">global</span> ExitFlag</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    flag = <span class="keyword">False</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    usb_dir = <span class="stringliteral">&quot;/&quot;</span> + usb_dir + <span class="stringliteral">&quot;/&quot;</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="keywordflow">for</span> f <span class="keywordflow">in</span> files:</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        getstatusoutput(<span class="stringliteral">&quot;rm &quot;</span> + usb_dir + f)</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">if</span> getstatusoutput(<span class="stringliteral">&quot;stat &quot;</span> + usb_dir + f + <span class="stringliteral">&quot;.gpg&quot;</span>)[0] != 0:</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            Log(<span class="stringliteral">&quot;file &quot;</span> + f + <span class="stringliteral">&quot;.gpg&quot;</span> + <span class="stringliteral">&quot; not found&quot;</span>) <span class="comment"># не найден файл .gpg</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            <span class="keywordflow">continue</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">if</span> gpg_decrypt(usb_dir + f + <span class="stringliteral">&quot;.gpg&quot;</span>):</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            Log(<span class="stringliteral">&quot;Start update &quot;</span> + f) <span class="comment"># обновление файлов gpg</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            getstatusoutput(<span class="stringliteral">&quot;cp &quot;</span> + usb_dir + f + <span class="stringliteral">&quot; &quot;</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                            + dirname(abspath(__file__))</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                            + <span class="stringliteral">&quot;/&quot;</span> + f,</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                            logging=<span class="keyword">True</span>)</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            getstatusoutput(<span class="stringliteral">&quot;cp &quot;</span> + dirname(abspath(__file__)) <span class="comment"># BACKUP файдлв</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                            + <span class="stringliteral">&quot;/&quot;</span> + f</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                            + <span class="stringliteral">&quot; &quot;</span> + dirname(abspath(__file__))</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                            + <span class="stringliteral">&quot;/&quot;</span> + f + <span class="stringliteral">&quot;.BACKUP&quot;</span>,</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                            logging=<span class="keyword">True</span>)</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            getstatusoutput(<span class="stringliteral">&quot;chmod 755 &quot;</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                            + dirname(abspath(__file__))</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                            + <span class="stringliteral">&quot;/&quot;</span> + f,</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                            logging=<span class="keyword">True</span>)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            getstatusoutput(<span class="stringliteral">&quot;rm &quot;</span> + usb_dir + f,</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                            logging=<span class="keyword">True</span>)</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            getstatusoutput(<span class="stringliteral">&quot;mv &quot;</span> + usb_dir + f + <span class="stringliteral">&quot;.gpg &quot;</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                            + usb_dir + f + <span class="stringliteral">&quot;.gpg.OLD&quot;</span>,</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                            logging=<span class="keyword">True</span>)</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            flag = <span class="keyword">True</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="keywordflow">if</span> flag:</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        Log(<span class="stringliteral">&quot;Finish update: exit (wait for free all ports)&quot;</span>)</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        ExitFlag = <span class="keyword">True</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_ad24525bcc431f0f8c030e24bed019a6f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_ad24525bcc431f0f8c030e24bed019a6f">&#9670;&nbsp;</a></span>UsbMount()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.UsbMount </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция монтирования usb. </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">device</td><td>- устройство </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="keyword">def </span>UsbMount(device):</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    retval, output = getstatusoutput(<span class="stringliteral">&quot;pmount &quot;</span> + device.device_node)</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keywordflow">return</span> [retval, re.sub(<span class="stringliteral">r&#39;dev&#39;</span>, <span class="stringliteral">&#39;media&#39;</span>, device.device_node)]</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="file_a8078bdb80f1dc3e035795dbceec779aa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a8078bdb80f1dc3e035795dbceec779aa">&#9670;&nbsp;</a></span>UsbUmount()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def isofc-service.UsbUmount </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>device</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Функция размонтирования usb. </p>
<dl class="params"><dt>Аргументы</dt><dd>
  <table class="params">
    <tr><td class="paramname">device</td><td>- устройство </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keyword">def </span>UsbUmount(device):</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    retval, output = getstatusoutput(<span class="stringliteral">&quot;pumount &quot;</span> + device.device_node)</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keywordflow">if</span> Status(device) != StatusMsg[<span class="stringliteral">&#39;Free&#39;</span>]:</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="keywordflow">if</span> Status(device).find(StatusMsg[<span class="stringliteral">&#39;Error&#39;</span>]) &gt;= 0:</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            StatusSet(device,</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                      Status(device)</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                      + StatusMsg[<span class="stringliteral">&#39;DisconnectAddition&#39;</span>],</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                      StatusClrs[<span class="stringliteral">&#39;Error&#39;</span>])</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            StatusSet(device, StatusMsg[<span class="stringliteral">&#39;DisconnectPlease&#39;</span>],</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                      StatusClrs[<span class="stringliteral">&#39;DisconnectPlease&#39;</span>])</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    <span class="keywordflow">return</span> retval</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Переменные</h2>
<a id="file_a32430ce5e336e5cb8ec2df27f66b86dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a32430ce5e336e5cb8ec2df27f66b86dd">&#9670;&nbsp;</a></span>StatusClrs</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">dictionary isofc-service.StatusClrs</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Инициализатор</b><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;=  {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    <span class="stringliteral">&#39;Normal&#39;</span>: <span class="stringliteral">&#39;white&#39;</span>,</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="stringliteral">&#39;Error&#39;</span>: <span class="stringliteral">&#39;red&#39;</span>,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    <span class="stringliteral">&#39;Copying&#39;</span>: <span class="stringliteral">&#39;yellow&#39;</span>,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    <span class="stringliteral">&#39;DisconnectPlease&#39;</span>: <span class="stringliteral">&#39;green&#39;</span>,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;}</div></div><!-- fragment -->
</div>
</div>
<a id="file_a86c2854b086f3034ce6820a9db41f34b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#file_a86c2854b086f3034ce6820a9db41f34b">&#9670;&nbsp;</a></span>StatusMsg</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">dictionary isofc-service.StatusMsg</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Инициализатор</b><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;=  {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    <span class="stringliteral">&#39;Free&#39;</span>: <span class="stringliteral">&#39;Free&#39;</span>,</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="stringliteral">&#39;Connected&#39;</span>: <span class="stringliteral">&#39;Connected&#39;</span>,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    <span class="stringliteral">&#39;Copying&#39;</span>: <span class="stringliteral">&#39;Copying&#39;</span>,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    <span class="comment"># Warn: all *Error must contain &#39;Error&#39; value (for ex.: &#39;Ошибка&#39;)</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    <span class="stringliteral">&#39;Error&#39;</span>: <span class="stringliteral">&#39;Error&#39;</span>,</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    <span class="stringliteral">&#39;MountError&#39;</span>: <span class="stringliteral">&#39;Mount error&#39;</span>,</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    <span class="stringliteral">&#39;CopyError&#39;</span>: <span class="stringliteral">&#39;Copy error&#39;</span>,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="stringliteral">&#39;UmountError&#39;</span>: <span class="stringliteral">&#39;Umount error&#39;</span>,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    <span class="stringliteral">&#39;Connecting&#39;</span>: <span class="stringliteral">&#39;Connecting&#39;</span>,</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    <span class="stringliteral">&#39;ConnectingError&#39;</span>: <span class="stringliteral">&#39;Connecting error&#39;</span>,</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    <span class="stringliteral">&#39;AuthFileNotFoundError&#39;</span>: <span class="stringliteral">&#39;No aut file&#39;</span>,</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="stringliteral">&#39;AuthSmbError&#39;</span>: <span class="stringliteral">&#39;Check log or path&#39;</span>,</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    <span class="stringliteral">&#39;MoreOneLogin&#39;</span>: <span class="stringliteral">&#39;Login in use&#39;</span>,</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    <span class="stringliteral">&#39;WrongAuthFileError&#39;</span>: <span class="stringliteral">&#39;Wrong aut file&#39;</span>,</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    <span class="stringliteral">&#39;TransferError&#39;</span>: <span class="stringliteral">&#39;Transfer error&#39;</span>,</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    <span class="stringliteral">&#39;DisconnectPlease&#39;</span>: <span class="stringliteral">&#39;Done&#39;</span>,</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    <span class="stringliteral">&#39;DisconnectAddition&#39;</span>: <span class="stringliteral">&#39;, extract&#39;</span>,</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;}</div></div><!-- fragment -->
<p>Сообщения для вывода на дисплей </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Создано системой &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
